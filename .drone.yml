kind: pipeline
name: cicd-image

steps:

- name: start docker
  image: docker:dind
  detach: true
  privileged: true
  volumes:
  - name: dockersock
    path: /var/run/

- name: "docker build helm-builder"
  image: keyporttech/helm-builder:2.12-3
  volumes:
  - name: dockersock
    path: /var/run/
  commands:
  - "export LATEST_KUBERNETES_RELEASE=$(curl -sSL https://dl.k8s.io/release/stable.txt)"
  - "export LATEST_HELM_RELEASE=$(./latestHelmVersion.sh)"
  - "docker build --build-arg HELM_VERSION=$(./latestHelmVersion.sh) --build-arg KUBERNETES_VERSION=$(curl -sSL https://dl.k8s.io/release/stable.txt) ./docker/helm-builder"
  when:
  event:
    include:
    - pull_request

- name: "github release and dockerhub publish helm-builder"
  environment:
    DOCKER_TAG: keyporttech/helm-builder:2.12-3
    DOCKERHUB_USERNAME:
      from_secret: USERNAME
    DOCKERHUB_PASSWORD:
      from_secret: PASSWORD
  image: docker
  volumes:
  - name: dockersock
    path: /var/run/
  commands:
  - "docker build ./docker/helm-builder/ -t $DOCKER_TAG"
  - "newVersion=$(./version.sh)"
  - "docker login"
  - "docker build ./docker/helm-builder -t ${DOCKER_TAG}:${newVersion}"
  - "docker push ${DOCKER_TAG}:${newVersion}"
  - "git tag ${newVersion}"
  - "git push origin ${newVersion}"
  when:
    when:
    event:
      include:
      - push
      exclude:
      - pull_request
    branch:
    - master

volumes:
- name: dockersock
  temp: {}
